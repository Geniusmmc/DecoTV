# 用户注册功能使用指南

## ✨ 功能特性

### 🔐 安全防护

- ✅ **图形验证码**：4 位随机字母数字组合，防止机器人批量注册
- ✅ **验证码刷新**：可随时点击刷新，提高可用性
- ✅ **防暴力破解**：验证码错误 5 次后自动失效
- ✅ **验证码过期**：5 分钟自动过期，防止重放攻击
- ✅ **用户名规则**：严格的用户名格式验证
- ✅ **密码强度**：基础密码复杂度要求

### 📝 表单验证

- **用户名验证**：

  - 长度：3-20 个字符
  - 格式：只能包含字母、数字和下划线
  - 限制：不能全是数字
  - 黑名单：admin、root、administrator 等保留名称

- **密码验证**：

  - 长度：6-50 个字符
  - 强度：不能全是数字
  - 确认：需要两次输入一致

- **实时提示**：输入时即时显示验证错误

### 🎨 用户体验

- ✅ 精美的渐变 UI 设计
- ✅ 深色模式支持
- ✅ 响应式布局（手机/平板/电脑）
- ✅ 平滑的动画效果
- ✅ 友好的错误提示
- ✅ 注册成功自动跳转登录

## 🚀 启用方法

### 前提条件

1. **存储模式要求**：必须使用以下存储方式之一

   - ✅ Redis
   - ✅ Upstash Redis
   - ✅ Kvrocks
   - ❌ LocalStorage（不支持多用户）

2. **环境变量配置**：

```bash
# .env.local 或部署平台环境变量

# 存储类型（必须）
NEXT_PUBLIC_STORAGE_TYPE=redis  # 或 upstash、kvrocks

# 启用注册（必须）
NEXT_PUBLIC_ENABLE_REGISTRATION=true

# Redis 配置（根据选择的存储类型配置）
REDIS_URL=redis://localhost:6379
# 或使用 Upstash（变量名是 UPSTASH_URL 和 UPSTASH_TOKEN）
UPSTASH_URL=https://xxx.upstash.io
UPSTASH_TOKEN=your_token
# 或
KVROCKS_URL=redis://kvrocks-host:6666
```

### 本地开发启用

1. 复制环境变量示例：

   ```bash
   cp .env.example .env.local
   ```

2. 编辑 `.env.local`：

   ```bash
   NEXT_PUBLIC_STORAGE_TYPE=redis
   NEXT_PUBLIC_ENABLE_REGISTRATION=true
   REDIS_URL=redis://localhost:6379
   ```

3. 重启开发服务器：

   ```bash
   pnpm dev
   ```

4. 访问注册页面：

   ```
   http://localhost:3000/register
   ```

### Vercel/ClawCloud 部署启用

1. 进入部署平台项目设置
2. 找到 "Environment Variables"（环境变量）
3. 添加以下变量：

   ```bash
   NEXT_PUBLIC_STORAGE_TYPE=upstash
   NEXT_PUBLIC_ENABLE_REGISTRATION=true
   UPSTASH_URL=https://xxx.upstash.io
   UPSTASH_TOKEN=your_token
   ```

   > 💡 **重要提示**：环境变量名是 `UPSTASH_URL` 和 `UPSTASH_TOKEN`（不是 `UPSTASH_REDIS_REST_*`）

4. 重新部署项目

### Docker 部署启用

编辑 `docker-compose.yml` 或在启动时传入环境变量：

```yaml
environment:
  - NEXT_PUBLIC_STORAGE_TYPE=redis
  - NEXT_PUBLIC_ENABLE_REGISTRATION=true
  - REDIS_URL=redis://redis:6379
```

## 📱 使用流程

### 用户注册流程

1. **访问注册页面**

   - 网址：`https://你的域名/register`
   - 或从登录页点击"没有账号？立即注册"

2. **填写注册信息**

   - 输入用户名（3-20 字符）
   - 输入密码（至少 6 位）
   - 确认密码
   - 输入验证码（点击图片可刷新）

3. **提交注册**

   - 系统自动验证信息
   - 通过后创建账号
   - 自动跳转到登录页

4. **登录使用**
   - 使用新账号登录
   - 开始使用 DecoTV

## 🔒 安全建议

### 🟢 推荐做法

1. **默认关闭注册**

   - 部署后先关闭注册功能
   - 仅在需要时临时开启
   - 注册完成后再次关闭

2. **监控用户注册**

   - 定期检查用户列表（`/admin` 页面）
   - 及时清理异常账号
   - 使用用户封禁功能管理

3. **限制注册时间**

   - 仅在特定时间段开放注册
   - 使用环境变量快速开关

4. **配合用户组使用**
   - 新用户自动分配到特定用户组
   - 限制新用户的 API 访问权限
   - 防止滥用服务器资源

### 🔴 不推荐做法

- ❌ 公开部署时长期开放注册
- ❌ 不监控用户注册情况
- ❌ 给所有新用户完整权限
- ❌ 在社交媒体公开注册链接

## 🛡️ 防护机制

### 已实现的防护

| 防护类型         | 说明                   | 状态      |
| ---------------- | ---------------------- | --------- |
| **图形验证码**   | 4 位随机字符，防机器人 | ✅ 已实现 |
| **验证码过期**   | 5 分钟自动失效         | ✅ 已实现 |
| **错误次数限制** | 5 次错误后需重新获取   | ✅ 已实现 |
| **用户名黑名单** | 禁止保留用户名         | ✅ 已实现 |
| **格式验证**     | 严格的输入格式检查     | ✅ 已实现 |
| **重复检查**     | 防止用户名冲突         | ✅ 已实现 |
| **环境变量开关** | 随时可关闭注册         | ✅ 已实现 |

### 未来可增强的防护（可选）

- 📧 邮箱验证
- 📱 手机验证码
- 🎫 邀请码系统
- ⏱️ IP 频率限制
- 🤖 reCAPTCHA 集成
- 📊 注册统计和监控

## 🎯 使用场景

### ✅ 适合的场景

1. **家庭/朋友共享**

   - 允许家人朋友注册账号
   - 每人独立的观看记录
   - 个性化收藏和设置

2. **小团队使用**

   - 公司内部影视库
   - 团队协作观看
   - 权限分级管理

3. **私有社区**
   - 封闭的影迷社区
   - 成员制访问
   - 定向邀请注册

### ❌ 不适合的场景

1. **公开服务**

   - 面向互联网的公开注册
   - 可能导致法律风险
   - 服务器压力过大

2. **商业运营**
   - 收费订阅服务
   - 需要完整的支付系统
   - 本项目不支持商业用途

## 🔧 管理注册用户

### 查看用户列表

1. 登录管理员账号
2. 访问 `/admin` 页面
3. 查看"用户配置"卡片
4. 查看所有已注册用户

### 管理用户权限

**可进行的操作**：

- 🚫 封禁用户
- ✅ 解除封禁
- 👑 设置管理员
- 📊 配置 API 权限
- 🏷️ 分配用户组
- 🗑️ 删除用户

### 批量管理

- 使用用户组功能批量管理权限
- 一次性配置多个用户的访问范围
- 灵活的标签（tags）系统

## 📊 常见问题

### Q1: 为什么看不到注册页面？

**原因**：

- 环境变量 `NEXT_PUBLIC_ENABLE_REGISTRATION` 未设置为 `true`
- 使用了 `localstorage` 存储模式
- 未重启服务器

**解决**：

1. 检查环境变量配置
2. 确保使用 Redis/Upstash/Kvrocks
3. 重启开发服务器或重新部署

### Q2: 验证码看不清怎么办?

**解决**：点击验证码图片即可刷新，或点击右下角刷新按钮

### Q3: 显示"注册功能未开启"?

**原因**：`NEXT_PUBLIC_ENABLE_REGISTRATION` 未设置或为 `false`

**解决**：在环境变量中设置为 `true` 并重启

### Q4: 显示"当前存储模式不支持"?

**原因**：使用了 `localstorage` 模式

**解决**：

1. 配置 Redis/Upstash/Kvrocks
2. 更改 `NEXT_PUBLIC_STORAGE_TYPE`
3. 重启服务

### Q5: 注册成功后无法登录?

**可能原因**：

- 用户被管理员封禁
- 数据库连接问题
- 密码输入错误

**解决**：

1. 检查管理后台用户状态
2. 确认数据库连接正常
3. 重置密码（联系管理员）

### Q6: 如何临时关闭注册?

**最简单方法**：

1. 设置环境变量 `NEXT_PUBLIC_ENABLE_REGISTRATION=false`
2. 重启服务（无需修改代码）

### Q7: 验证码总是错误?

**可能原因**：

- 大小写输入问题（系统已自动转大写）
- 验证码已过期
- 尝试次数过多

**解决**：点击刷新验证码重新获取

## 📝 技术细节

### API 端点

**获取验证码**：

```http
GET /api/register?action=captcha
Response: { svg: "...", sessionId: "..." }
```

**提交注册**：

```http
POST /api/register
Body: {
  username: string,
  password: string,
  confirmPassword: string,
  captcha: string,
  sessionId: string
}
```

### 注册流程

```
用户填写表单
    ↓
前端验证（格式、密码匹配等）
    ↓
获取验证码（SVG图片）
    ↓
用户输入验证码
    ↓
提交到后端API
    ↓
后端验证（验证码、用户名重复等）
    ↓
写入数据库（db.registerUser）
    ↓
更新配置文件（AdminConfig）
    ↓
返回成功响应
    ↓
自动跳转登录页
```

### 验证码机制

- **生成**：随机 4 位字母数字（排除易混淆字符如 0、O、I、l）
- **存储**：内存 Map 存储（生产环境建议用 Redis）
- **渲染**：SVG 格式，带随机颜色、旋转、干扰线和干扰点
- **过期**：5 分钟自动清理
- **防刷**：单个验证码最多尝试 5 次

## 🎉 总结

用户注册功能已完全集成到 DecoTV，具备：

✅ **安全可靠**：图形验证码 + 多重验证
✅ **使用简单**：环境变量一键开关
✅ **体验优秀**：精美 UI + 实时验证
✅ **易于管理**：完整的后台管理功能
✅ **灵活控制**：随时可开启/关闭

**推荐使用方式**：

1. 默认关闭注册
2. 需要时临时开启
3. 注册完成后立即关闭
4. 定期检查用户列表
5. 合理配置用户权限

---

**最后更新**：2025 年 10 月 14 日

有问题欢迎反馈！ 🙏
